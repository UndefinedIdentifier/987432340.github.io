title: 安卓源码编译(续)
layout: post
date: 2016-04-28 01:23:30
categories: 移动安全
tags: [源码, 编译]
---

一些源码编译常用的小技巧
<!--more-->

# 安卓源码编译




make生成的编译结果输出目录为out/target/product/$(TARGET_PRODUCT)，$(TARGET_PRODUCT)是一个环境变量，默认值是generic。

编译成功之后，可以执行

```
make sdk
```



打包成SDK，输出为SDK，有了这个SDK，可以在IDE下进行android开发



## 运行安卓模拟机 

在启动模拟器之前，需要先为模拟器系统设置环境变量

```
export ANDROID_PRODUCT_OUT=安卓源码下/out/target/product/generic # 镜像文件目录
export ANDROID_PRODUCT_OUT_BIN=安卓源码下/out/host/linux-x86/bin #模拟器目录
export PATH=${PATH}:${ANDROID_PRODUCT_OUT_BIN}:${ANDROID_PRODUCT_OUT};#将上面2个路径加入path
```

执行

```
source build/envsetup.sh
lunch 
emulator
```

启动模拟器。启动模拟器会用到4个文件

```
zImage
system.img
userdata.img
ramdisk.img
```

第一个是linux内核镜像，后3个是android系统镜像。

默认参数运行模拟器，使用的是zImage文件是安卓源码下的/out/host/linux-x86/bin中的kernel-qemu文件。而默认的镜像文件位于ANDROID_PRODUCT_OUT目录下。



# 编译内核源码

安卓源码不包括内核源码，下载下来之后先改内核代码目录下的makefile文件，再添加编译工具链的路径到环境变量，再make。

生成的新的内核，我们可以用来启动模拟器

```
emulator -kernel ./kernel/goldfish/arch/arm/boot/zImage &
```

&符号是制定模拟器在后台运行，命令行不会被占用。通过adb shell连上模拟器。

```
cd proc
cat version
```

得到的回显会有内核的编译时间，版本等信息用来判断这个内核是否是我们新编译出来的。



# 验证程序编写



通常把实验性质的android应用放在packages/experimental目录下。在安卓源码环境下开发安卓应用程序不要用make命令编译整个android源码工程，单独编译新增的安卓应用模块就可以了。新增的安卓应用经过编译、重打包到system.img后，我们就可以使用新的system.img文件来启动android模拟器。启动后可以便可以点开试用。



总体上讲，单独打包android应用程序模块用到2个命令。

```
mmm 			#单独编译某一模块
make snod 		#单独执行打包android系统镜像文件system.img
```



使用mmm之前先执行脚本，帮我们设置好环境变量

```
source ./build/envsetup.sh
```

现在就可以用mmm命令了，例如

```
mmm ./packages/experimental/HelloWorld/
```

编译完成后在

> /out/target/product/generic/system/app

目录下。

如果要编译c可以执行文件或者动态链接库文件，输出在

> out/target/product/generic/system/lib/hw

目录下

接着，再重打包system.img

```
make snod
```

新的系统镜像文件在out/target/product/generic目录下。有了新的系统镜像，再执行模拟器，就会加载这个新的系统镜像。

