title: 2016安卓源码编译笔记
layout: post
date: 2016-04-28 01:23:30
categories: 移动安全
tags: [源码, 编译]
---
# 目标

拥有一台google亲儿子， Nexus 4，放在宿舍里大半年也没有排上用场。对它做2件事：

1. 用官方镜像刷机
2. 用自己编译的android系统再刷一次

从[镜像工厂](https://developers.google.com/android/nexus/images#occam)能看到nexus 4能刷的版本系统版本从4.2.2到5.1.1，小括号里是此版本的代号。这里我选择用官方4.3的镜像刷机，同时也编译4.3源码刷机。

<!--more-->

# 一、安装虚拟机

下载 Ubuntu 14.04 LTS 64位版本的系统，也是官方推荐的系统版本，在虚拟机中用简易安装的方式，连VMtools都是自动装好，非常方便。（后记：我的机子带不动虚拟机引发问题3，后用实体机编译源码成功）。

注意事项：

- 系统的硬盘大小在100G以上最好


- 如果机子不好请用实体机（多么痛的领悟）



## 1. 配置网络连接

简易安装自带NAT联网方式，DHCP貌似没什么卵用，需要手动配置DNS。本着简单粗暴的原则，我把联网方式改为桥接，直接就连上了。



## 2. 修改更新源

自带的官方更新源比较慢，换成阿里的更新源。

- 备份原文件

```
sudo cp /etc/apt/sources.list /etc/apt/sources.list_bak
```

- 打开source.list文件

```
sudo gedit /etc/apt/sources.list
```

- 删除所有内容，贴入下面的源

```
deb http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse
```

- 刷新列表(一定要刷一下)

```
sudo apt-get update
```

  到了这一步，虚拟机环境配置的工作就完成了。



# 二、源码编译环境搭建

这一步主要是安装一些编译环境所需的工具，如果安装成功了，则可以直接编译android源码。

## 1. 安装JDK

在Android 4.4和更老的版本中，使用的是Oracle JDK，而到了Android 5.0以后，Google将其换为OpenJDK（也许是为了专利考虑）.我们编译4.3源码，就用Oracle JDK。并且官方给了提示，不同版本的android源码选用的JDK版本也不尽相同.

```
To develop older versions of Android, download and install the corresponding version of the Java JDK:
Java 7: for Lollipop through Marshmallow
Java 6: for Gingerbread through KitKat
Java 5: for Cupcake through Froyo
```

我们4.3源码落在JAVA6的范围中。去[oracle官网](http://www.oracle.com/technetwork/java/javasebusiness/downloads/java-archive-downloads-javase6-419409.html#jdk-6u45-oth-JPR)下载linux64位版本的JDK1.6。可是下载还要账号，找到了别人在新浪微盘分享的JDK1.6的安装包jdk-6u45-linux-x64.bin。

接下来，几乎全部参考这个[链接](http://blog.csdn.net/gobitan/article/details/24322561)

```
(1) 创建java目录
$ sudo mkdir -p /usr/local/java
将你下载的jdk-6u45-linux-x64.bin拷贝至/usr/local/java目录
$ cd /usr/local/java
$ sudo cp /home/dennis/Downloads/jdk-6u45-linux-x64.bin .

(2) 解压bin文件
$ sudo chmod +x jdk-6u45-linux-x64.bin
$ sudo ./jdk-6u45-linux-x64.bin
$ sudo rm -rf jdk-6u45-linux-x64.bin

第四步：配置Orache JDK
 (1) 配置JAVA_HOME和PATH环境变量
$ sudo vi /etc/profile
在该文件的末尾加上如下部分：
JAVA_HOME=/usr/local/java/jdk1.6.0_45
PATH=$PATH:$HOME/bin:$JAVA_HOME/bin
export JAVA_HOME
export PATH

(2) 配置ubuntu的JDK和JRE的位置
$ sudo update-alternatives --install "/usr/bin/java" "java" "/usr/local/java/jdk1.6.0_45/bin/java" 1
$ sudo update-alternatives --install "/usr/bin/javac" "javac" "/usr/local/java/jdk1.6.0_45/bin/javac" 1
$ sudo update-alternatives --install "/usr/bin/javaws" "javaws" "/usr/local/java/jdk1.6.0_45/bin/javaws" 1

(3) 配置Oracle为系统默认JDK/JRE
$ sudo update-alternatives --set java /usr/local/java/jdk1.6.0_45/bin/java
$ sudo update-alternatives --set javac /usr/local/java/jdk1.6.0_45/bin/javac
$ sudo update-alternatives --set javaws /usr/local/java/jdk1.6.0_45/bin/javaws

配置完成后，执行如下命令使其立即生效。
$ . /etc/profile
再次执行"java -version"显示如下：
dennis@dubuntu1404:~$ java -version
java version "1.6.0_45"
Java(TM) SE Runtime Environment (build 1.6.0_45-b06)
Java HotSpot(TM) 64-Bit Server VM (build 20.45-b01, mixed mode)
```

## 2. 安装其他软件包

```
android-user@ubuntu:~$ sudo apt-get install bison g++-multilib git gperf libxml2-utils make python-networkx zlib1g-dev:i386 zip

The following packages have unmet dependencies:
 g++-multilib : Depends: gcc-multilib (>= 4:4.8.2-1ubuntu6) but it is not going to be installed
                Depends: g++ (>= 4:4.8.2-1ubuntu6) but it is not going to be installed
                Depends: g++-4.8-multilib (>= 4.8.2-5~) but it is not going to be installed
E: Unable to correct problems, you have held broken packages.

android-user@ubuntu:~$ sudo apt-get install gcc-multilib

android-user@ubuntu:~$ sudo apt-get install bison g++-multilib git gperf libxml2-utils make python-networkx zlib1g-dev:i386 zip
The following packages have unmet dependencies:
 g++-multilib : Depends: g++ (>= 4:4.8.2-1ubuntu6) but it is not going to be installed
E: Unable to correct problems, you have held broken packages.

android-user@ubuntu:~$ sudo apt-get install g++

android-user@ubuntu:~$ sudo apt-get install bison g++-multilib git gperf libxml2-utils make python-networkx zlib1g-dev:i386 zip
```

## 3. 配置USB访问权限

这一步相当于在windows下安装设备的驱动一样，如果不这样做，就算电脑连上了我们的手机，系统也识别不出来。

**写配置文件**：将如下内容加入到/etc/udev/rules.d/51-android.rules文件中

```
# adb protocol on passion (Nexus One)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="4e12", MODE="0600", OWNER="<username>"
# fastboot protocol on passion (Nexus One)
SUBSYSTEM=="usb", ATTR{idVendor}=="0bb4", ATTR{idProduct}=="0fff", MODE="0600", OWNER="<username>"
# adb protocol on crespo/crespo4g (Nexus S)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="4e22", MODE="0600", OWNER="<username>"
# fastboot protocol on crespo/crespo4g (Nexus S)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="4e20", MODE="0600", OWNER="<username>"
# adb protocol on stingray/wingray (Xoom)
SUBSYSTEM=="usb", ATTR{idVendor}=="22b8", ATTR{idProduct}=="70a9", MODE="0600", OWNER="<username>"
# fastboot protocol on stingray/wingray (Xoom)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="708c", MODE="0600", OWNER="<username>"
# adb protocol on maguro/toro (Galaxy Nexus)
SUBSYSTEM=="usb", ATTR{idVendor}=="04e8", ATTR{idProduct}=="6860", MODE="0600", OWNER="<username>"
# fastboot protocol on maguro/toro (Galaxy Nexus)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="4e30", MODE="0600", OWNER="<username>"
# adb protocol on panda (PandaBoard)
SUBSYSTEM=="usb", ATTR{idVendor}=="0451", ATTR{idProduct}=="d101", MODE="0600", OWNER="<username>"
# adb protocol on panda (PandaBoard ES)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="d002", MODE="0600", OWNER="<username>"
# fastboot protocol on panda (PandaBoard)
SUBSYSTEM=="usb", ATTR{idVendor}=="0451", ATTR{idProduct}=="d022", MODE="0600", OWNER="<username>"
# usbboot protocol on panda (PandaBoard)
SUBSYSTEM=="usb", ATTR{idVendor}=="0451", ATTR{idProduct}=="d00f", MODE="0600", OWNER="<username>"
# usbboot protocol on panda (PandaBoard ES)
SUBSYSTEM=="usb", ATTR{idVendor}=="0451", ATTR{idProduct}=="d010", MODE="0600", OWNER="<username>"
# adb protocol on grouper/tilapia (Nexus 7)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="4e42", MODE="0600", OWNER="<username>"
# fastboot protocol on grouper/tilapia (Nexus 7)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="4e40", MODE="0600", OWNER="<username>"
# adb protocol on manta (Nexus 10)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="4ee2", MODE="0600", OWNER="<username>"
# fastboot protocol on manta (Nexus 10)
SUBSYSTEM=="usb", ATTR{idVendor}=="18d1", ATTR{idProduct}=="4ee0", MODE="0600", OWNER="<userame>"
```

**改配置文件**

```
#查看当前用户名
android.rulesandroid@ubuntu:/usr/local/java$ echo $USER
android
#把文本中的<username>字串替换成我们自己的用户名，我这里是android
android@ubuntu:/usr/local/java$ sudo sed -i 's/<username>/android/g' /etc/udev/rules.d/51-android.rules 
```

## 4. 配置ccache

>You can optionally tell the build to use the ccache compilation tool. Ccache acts as a compiler cache that can be used to speed up rebuilds. This works very well if you use make clean often, or if you frequently switch between different build products.

ccache是加速编译源码的工具，对经常使用make clean，或选择不同编译版本时非常有用。

```
sudo apt-get install ccache  
vim ~/.bashrc 

```

在最后一行加上

```
export USE_CCACHE=1
```

> 下载并解压好源码后

**设置ccache**:cd 到源码根目录

```
prebuilts/misc/linux-x86/ccache/ccache -M 10G
```
# 三、编译源码



## 1. Obtaining proprietary binaries

在编译之前要设置好vendor目录。

打开[链接](https://developers.google.com/android/nexus/drivers),搜索JWR66Y，在Binaries for Nexus S ("crespo")目录下找到Nexus 4 binaries for Android 4.3 (JWR66Y)，这里有3个link链接，全下载下来，3个文件都是脚本，解压后放到源码根目录下。依次执行sh extract-xxxx.sh并输入I ACCEPT。最后你会发现源码根目录下增加了vendor目录。



- 初始化编译环境(都是在源码根目录下)

```
. build/envsetup.sh
```

- 选择编译目标包

```
chris@cc:~/android-4.3_r1$ lunch

You're building on Linux

Lunch menu... pick a combo:
     1. aosp_arm-eng
     2. aosp_x86-eng
     3. aosp_mips-eng
     4. vbox_x86-eng
     5. aosp_flo-userdebug
     6. full_grouper-userdebug
     7. full_tilapia-userdebug
     8. mini_armv7a_neon-userdebug
     9. mini_mips-userdebug
     10. mini_x86-userdebug
     11. full_mako-userdebug
     12. full_maguro-userdebug
     13. full_manta-userdebug
     14. full_arndale-userdebug
     15. full_toroplus-userdebug
     16. full_toro-userdebug
     17. full_panda-userdebug
```

这一步可以参考[官方链接](https://source.android.com/source/running.html#selecting-device-build)，由下图我们知道Nexus4需要选择11

| Device  | Code name    | Build configuration |
| ------- | ------------ | ------------------- |
| Nexus 4 | occam (mako) | full_mako-userdebug |



接着可以编译我们想要的任何模块，我们编译一个最简单的scp模块。j4是同时进行的任务数

```
chris@cc:~/android-4.3_r1$ make scp -j4
============================================
PLATFORM_VERSION_CODENAME=REL
PLATFORM_VERSION=4.3
TARGET_PRODUCT=full
TARGET_BUILD_VARIANT=eng
TARGET_BUILD_TYPE=release
TARGET_BUILD_APPS=
TARGET_ARCH=arm
TARGET_ARCH_VARIANT=armv7-a
TARGET_CPU_VARIANT=generic
HOST_ARCH=x86
HOST_OS=linux
HOST_OS_EXTRA=Linux-4.2.0-27-generic-x86_64-with-Ubuntu-14.04-trusty
HOST_BUILD_TYPE=release
BUILD_ID=JWR66V
OUT_DIR=out
============================================
```

我这里双核的，直接make -j4，可以编译出system.img等。

##2. 错误解决方案

**错误1**（[参考链接](http://blog.csdn.net/nxh_love/article/details/8834849)）



```
/bin/bash: flex: command not found
make: *** [out/host/linux-x86/obj/EXECUTABLES/aidl_intermediates/aidl_language_l.cpp] Error 127
```

解决方案：

```
sudo apt-get install flex
```

**错误2**（[参考](http://stackoverflow.com/questions/23314652/cant-locate-switch-pm)）

```
Can't locate Switch.pm in @INC (you may need to install the Switch module) (@INC contains: /etc/perl /usr/local/lib/perl/5.18.2 /usr/local/share/perl/5.18.2 /usr/lib/perl5 /usr/share/perl5 /usr/lib/perl/5.18 /usr/share/perl/5.18 /usr/local/lib/site_perl .) at external/webkit/Source/WebCore/make-hash-tools.pl line 23.
```

解决方案：

```
sudo apt-get install libswitch-perl  
```

**错误3(奇葩的错误)**

```
collect2: ld ……………………
make: *** [out/target/product/generic/obj/SHARED_LIBRARIES/libwebcore_intermediates/LINKED/libwebcore.so] Error 1
```

在网上找到前人的经验都说是wsap分区不够大的问题。我照着解决方法增大swap分区，也就是linux下的虚拟内存。痛点来了，一定是我的小霸王4G物理机带不动，不管加多少内存，都还是一个结果，一气之下我用实体机重新安装了一下编译环境，果然就可以了，上个成功的图吧。



**错误4**：这实际上是一类java的问题

```
#错误1 找不到jar
/bin/bash: jar: command not found
make: *** [out/
/common/obj/JAVA_LIBRARIES/voip-common_intermediates/classes-full-debug.jar] Error 127
#错误2 找不到jacadoc
/bin/bash: line 2: javadoc: command not found
make: *** [out/target/common/docs/api-stubs-timestamp] Error 45
make: *** Waiting for unfinished jobs....
```

解决方法很简单，把它需要的jar，javah等放在找得到的地方

```
sudo ln -s /usr/local/java/jdk1.6.0_45/bin/jar /bin/jar
sudo ln -s /usr/local/java/jdk1.6.0_45/bin/java /bin/java
sudo ln -s /usr/local/java/jdk1.6.0_45/bin/javac /bin/javac
sudo ln -s /usr/local/java/jdk1.6.0_45/bin/javah /bin/javah
sudo ln -s /usr/local/java/jdk1.6.0_45/bin/javadoc /bin/javadoc
```

"/usr/local/java/jdk1.6.0_45"是我的jdk安装目录。





全部参考链接：



https://source.android.com/source/initializing.html#optimizing-a-build-environment
https://source.android.com/source/building.html
https://source.android.com/source/running.html#selecting-device-build
https://developers.google.com/android/nexus/images#occam
http://www.kaelli.com/10.html
http://blog.csdn.net/leiming32/article/details/49658657

http://blog.csdn.net/gobitan/article/details/24367439



# 四、谷歌官方镜像刷机

参考链接

>http://blog.csdn.net/leiming32/article/details/49658657
>
>https://developers.google.com/android/nexus/images#instructions



从下载镜像[参考链接1](https://developers.google.com/android/nexus/images#occam)看到nexus 4能刷的版本从4.2.2到5.1.1括号里是此版本的代号。我选择的源码是4.3_r1，所以代号是JWR66Y。下载官方镜像

```
scp ~/Downloads/occam-jwr66y-factory-74b1deab.tgz chris@192.168.1.111:/home/chris
```

安装fastboot、adb后边会用到。值得说明的是，作为一个没有安卓源码编译的人，fastboot(flash-all脚本会用到)、adb工具也可以从SDK Manager 的**Android SDK Platform-tools**目录中获取，所以在win上也是可以刷官方镜像的.

```
sudo apt-get install android-tools-fastboot android-tools-adb
```

手机连上电脑

```
adb reboot bootloader	//使用adb命令让设备开机
```

按照参考 [按键链接](https://source.android.com/source/building-devices.html#booting-into-fastboot-mode)

> Press and hold *Volume Down*, then press and hold *Power*

连续按下音量减小和电源键使手机进入**fastboot模式**，这是针对我的Nexus 4

解锁设备

> fastboot oem unlock

这里提示已经解锁过了

```
chris@cc:~$ fastboot oem unlock
...
FAILED (remote: Already Unlocked)
finished. total time: 0.001s
```

cd到镜像解压缩后的目录中执行命令

```
.\flash-all
```

刷机完成，重启！~





#五、使用源码刷机

编译完成之后，切换对于的目录 

```
chris@cc:~/android-4.3_r1$ ls out/target/product/
generic  mako
```

我们的版本是mako,generic是通用版本

```
chris@cc:~/android-4.3_r1$ ls
abi       cts          device      hardware         ndk       prebuilts  vendor
bionic    dalvik       docs        libcore          out       sdk
bootable  developers   external    libnativehelper  packages  system
build     development  frameworks  Makefile         pdk       tools
```

在这里就可以刷入我们新鲜出炉的镜像。

```
adb reboot bootloader	#设备重启，按下音量键和电源键切换到fastboot模式
fastboot -w -p flashall	#清除数据
fastboot flash boot boot.img		#刷入boot
fastboot flash recovery recovery.img		刷入img
```




